<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">

<head>
    <title>Blog Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            padding: 20px;
            margin-top: 5px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .posts {
            display: flex;
            flex-wrap: wrap;
        }

        .post-summary {
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            width: calc(30% - 20px);
            box-sizing: border-box;
            cursor: pointer;
        }

        .post-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .excerpt {
            font-size: 40px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .post-info {
            display: flex;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .post-tags {
            display: flex;
            flex-wrap: wrap;
        }

        .post-tags-info {
            display: flex;
            flex-wrap: wrap;
            background-color: #eee;
            padding: 2px 5px;
            margin: 5px;
            border-radius: 5px;
            font-size: 16px;
        }

        .accordion-toggle {
            display: none;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            width: 150px;
            background-color: #eee;
        }

        .accordion-content>* {
            margin: 10px;
            width: 500px;
        }

        .accordion-header {
            cursor: pointer;
            padding: 10px;
            background-color: #f0f0f0;
            display: block;
            width: 150px;
        }

        .accordion-toggle:checked+.accordion-header+.accordion-content {
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            margin: auto 20px auto 20px;
        }

        .options {
            display: flex;
            gap: 20px;
        }

        .pagination {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            padding: 10px 20px;
        }

        a,
        button {
            cursor: pointer;
            background-color: #999d99;
            min-height: 35px;
            max-height: 35px;
            padding: 10px 20px;
            border: 1px solid #ddd;
            box-sizing: border-box;

            color: white;
            border: none;
            font-size: 0.8em;
        }

        input,
        select,
        accordion-header {
            background-color: #f0f0f0;
            min-height: 35px;
            max-height: 35px;
            padding: 10px 20px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            font-size: 0.8em;
        }
    </style>
</head>

<body>
    <div class="container">

        <div class="header">
            <form th:action="@{/}" id="blogForm">
                <h1 onclick="document.getElementById('blogForm').submit();" style="cursor: pointer;">
                    Blog Application
                </h1>
            </form>

            <div class="header-right">
                <div class="search-login options">
                    <form th:action="@{/}" onchange="this.submit()">
                        <select id="sort" name="order">
                            <option value="latest" th:selected="${order == 'latest'}">Latest</option>
                            <option value="oldest" th:selected="${order == 'oldest'}">Oldest</option>
                        </select>
                    </form>
                    <a th:href="@{/newpost}">New Post</a>
                    <form th:action="@{/search}">
                        <input class="search-bar" name="searchQuery" th:value="${search_query}" placeholder="Search"
                            type="text" />
                        <select name="order" hidden>
                            <option value="latest" th:selected="${order == 'latest'}">Latest</option>
                            <option value="oldest" th:selected="${order == 'oldest'}">Oldest</option>
                        </select>
                        <button type="submit">Search</button>
                    </form>
                    <div  sec:authorize="hasAnyRole('AUTHOR','ADMIN')">
                        <span th:text="${#authentication.principal.firstName}"></span>
                        <span th:text="${#authentication.principal.lastName}"></span>
                    </div>
                    <div  sec:authorize="hasAnyRole('AUTHOR','ADMIN')">
                    <form class="logout" action="#" th:action="@{/logout}" method="POST">
                        <input type="submit" value="Logout">
                    </form>
                    </div>
                    <div  sec:authorize="!hasAnyRole('AUTHOR','ADMIN')">
                        <form class="logout" action="#" th:action="@{/login}" method="POST">
                            <input type="submit" value="Login">
                        </form>
                    </div>
                </div>
                <div class="filter-sort options">
                    <form class="options" th:action="@{/filter}" method="get">
                        <div id="select-date-section options" style="display: flex">
                            <label class="accordion-header" for="select-date">Select Date</label>
                                <input type="date" id="select-date" name="date">
                        </div>

                        <div id="select-tags-section">
                            <input class="accordion-toggle" id="select-tags" type="checkbox" />
                            <label class="accordion-header" for="select-tags">Select Tags</label>
                            <div class="accordion-content">
                                <div th:each="tag : ${tags}">
                                    <input name="tags" th:value="${tag}" type="checkbox"
                                        th:checked="${selectedTags != null and selectedTags.contains(tag)}" />
                                    <span th:text="${tag}"></span>
                                </div>
                            </div>
                        </div>

                        <div id="select-author-section">
                            <input class="accordion-toggle" id="select-author" type="checkbox" />
                            <label class="accordion-header" for="select-author">Select Authors</label>
                            <div class="accordion-content">
                                <div th:each="author : ${authors}">
                                    <input name="authors" th:value="${author.id}" type="checkbox"
                                        th:checked="${selectedAuthors != null and selectedAuthors.contains(author.id)}" />
                                    <span th:text="${author.firstName}"></span>
                                    <span th:text="${author.lastName}"></span>
                                </div>
                            </div>
                        </div>
                        <select name="order" hidden>
                            <option value="latest" th:selected="${order == 'latest'}">Latest</option>
                            <option value="oldest" th:selected="${order == 'oldest'}">Oldest</option>
                        </select>
                        <button type="submit">Filter</button>
                    </form>

                </div>
            </div>
        </div>

        <div class="posts">
            <div class="post-summary" th:each="post : ${posts}">
                <form class="clickable-form" method="get" th:action="@{/{id} (id=${post.id})}">
                    <div onclick="this.closest('form').submit()">
                        <h2 class="post-title" th:text="${post.title}"></h2>
                        <div class="post-info options">
                            <div>
                            <span th:text="${post.author.firstName}"></span>
                            <span th:text="${post.author.lastName}"></span>
                            </div>
                            <span th:text="${#temporals.format(post.publishedAt, 'yyyy-MM-dd HH:mm')}"></span>
                        </div>
                        <p class="post-info" th:text="${post.excerpt}"></p>
                        <div class="post-tags">
                            <span class="post-tags-info" th:each="tag : ${post.tags}" th:text="${tag.name}"></span>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pagination controls -->
        <div class="parent-pagination">
            <!-- Pagination for search -->
            <div  class="pagination"
                  th:if="${search_query != null and !search_query.isEmpty()}">
                <form th:action="@{/search}" method="get" >
                    <input type="hidden" name="pageNumber" th:value="${currentPage - 1}" />
                    <input type="hidden" name="pageSize" th:value="3" />
                    <input type="hidden" name="searchQuery" th:value="${search_query}" />
                    <input type="hidden" name="order" th:value="${order}" />
                    <button type="submit" th:if="${currentPage > 0}">Previous</button>
                </form>

                <form th:action="@{/search}" method="get">
                    <input type="hidden" name="pageNumber" th:value="${currentPage + 1}" />
                    <input type="hidden" name="pageSize" th:value="3" />
                    <input type="hidden" name="searchQuery" th:value="${search_query}" />
                    <input type="hidden" name="order" th:value="${order}" />
                    <button type="submit" th:if="${currentPage < totalPages - 1}">Next</button>
                </form>

            </div>

            <!-- Pagination for filter -->
            <div class="pagination"
                th:if="${date != null or selectedTags != null and !selectedTags.isEmpty() or selectedAuthors != null and !selectedAuthors.isEmpty()}">
                <form th:action="@{/filter}" method="get">
                    <input type="hidden" name="pageNumber" th:value="${currentPage - 1}" />
                    <input type="hidden" name="pageSize" th:value="3" />
                    <div th:each="tag : ${selectedTags}">
                        <input type="hidden" name="tags" th:value="${tag}" />
                    </div>
                    <div th:each="author : ${selectedAuthors}">
                        <input type="hidden" name="authors" th:value="${author}" />
                    </div>
                    <input type="hidden" name="order" th:value="${order}" />
                    <input type="hidden" name="date" th:value="${date}" />
                    <button type="submit" th:if="${currentPage > 0}">Previous</button>
                </form>
                <form th:action="@{/filter}" method="get">
                    <input type="hidden" name="pageNumber" th:value="${currentPage + 1}" />
                    <input type="hidden" name="pageSize" th:value="3" />
                    <div th:each="tag : ${selectedTags}">
                        <input type="hidden" name="tags" th:value="${tag}" />
                    </div>
                    <div th:each="author : ${selectedAuthors}">
                        <input type="hidden" name="authors" th:value="${author}" />
                    </div>
                    <input type="hidden" name="order" th:value="${order}" />
                    <input type="hidden" name="date" th:value="${date}" />
                    <button type="submit" th:if="${currentPage < totalPages - 1}">Next</button>
                </form>
            </div>

            <!-- Default Pagination -->
            <div class="pagination"
                th:if="${ date == null and (selectedTags == null or selectedTags.isEmpty()) and (selectedAuthors == null or selectedAuthors.isEmpty()) and (search_query == null or search_query.isEmpty())}">
                <form th:action="@{/}" method="get">
                    <input type="hidden" name="pageNumber" th:value="${currentPage - 1}" />
                    <input type="hidden" name="pageSize" th:value="3" />
                    <input type="hidden" name="order" th:value="${order}" />
                    <button type="submit" th:if="${currentPage > 0}">Previous</button>
                </form>
                <form th:action="@{/}" method="get">
                    <input type="hidden" name="pageNumber" th:value="${currentPage + 1}" />
                    <input type="hidden" name="pageSize" th:value="3" />
                    <input type="hidden" name="order" th:value="${order}" />
                    <button type="submit" th:if="${currentPage < totalPages - 1}">Next</button>
                </form>
            </div>
        </div>
    </div>
</body>

</html>